- hosts: bastion
  vars:
    is_master_only:  "{{ lookup('env','GI_MASTER_ONLY') }}"
    is_ocs_tainted:  "{{ lookup('env','GI_OCS_TAINTED') }}"
    internet_type:  "{{ lookup('env','GI_INTERNET_ACCESS') }}"
    storage_type:  "{{ lookup('env','GI_STORAGE_TYPE') }}"
    boot_name: "{{ lookup('env','GI_BOOTSTRAP_NAME') }}"
    domain:  "{{ lookup('env','GI_DOMAIN') }}"
    bas_ip:  "{{ lookup('env','GI_BASTION_IP') }}"
    ocadmin:  "{{ lookup('env','GI_OCADMIN') }}"
    ocadmin_password:  "{{ lookup('env','GI_OCADMIN_PWD') }}"
    storage_device: "{{ lookup('env','GI_STORAGE_DEVICE') }}"
    storage_device_size: "{{ lookup('env','GI_STORAGE_DEVICE_SIZE') }}"
    is_ics: "{{ lookup('env','GI_ICS') }}"
    ocp_release:  "{{ lookup('env','GI_OCP_RELEASE') }}"
    ocp_major_release: "{{ ocp_release.split('.')[:-1]|join('.') }}"


  tasks:
  - name: Check other configuration parameters
    fail: msg="Variable {{ item.name }} is not set"
    when: item.value == ""
    loop:
      - { name: "GI_MASTER_ONLY", value: "{{ is_master_only }}" }
      - { name: "GI_OCS_TAINTED", value: "{{ is_ocs_tainted }}" }
      - { name: "GI_INTERNET_ACCESS", value: "{{ internet_type }}" }
      - { name: "GI_STORAGE_TYPE", value: "{{ storage_type }}" }
      - { name: "GI_BOOTSTRAP_NAME", value: "{{ boot_name }}" }
      - { name: "GI_DOMAIN", value: "{{ domain }}" }
      - { name: "GI_BASTION_IP", value: "{{ bas_ip }}" }
      - { name: "GI_OCADMIN", value: "{{ ocadmin }}" }
      - { name: "GI_OCADMIN_PWD", value: "{{ ocadmin_password }}" }
      - { name: "GI_STORAGE_DEVICE", value: "{{ storage_device }}" }
      - { name: "GI_STORAGE_DEVICE_SIZE", value: "{{ storage_device_size }}" }
      - { name: "GI_ICS", value: "{{ is_ics }}" }
      - { name: "GI_OCP_RELEASE", value: "{{ ocp_release }}" }

  - set_fact:
      operator: "registry.{{ domain }}:5000/rook/ceph:v1.7.6"

  - set_fact:
      image: "{{ 'rook/ceph:v1.7.6' if internet_type != 'A' else operator }}"

  - name: Set parameters for air-gapped installation
    set_fact:
      archives_dir:  "{{ lookup('env','GI_ARCHIVES_DIR') }}"
      repo_user: "{{ lookup('env','GI_REPO_USER') }}"
      repo_user_password: "{{ lookup('env','GI_REPO_USER_PWD') }}"
    when: internet_type == 'A'

  - name: Check configuration parameters for air-gapped installation
    fail: msg="Variable {{ item.name }} is not set"
    loop:
      - { name: "GI_ARCHIVES_DIR", value: "{{ archives_dir }}" }
      - { name: "GI_REPO_USER", value: "{{ repo_user }}" }
      - { name: "GI_REPO_USER_PWD", value: "{{ repo_user_password }}" }
    when: internet_type == 'A' and item.value == ""

  - name: Set masters array
    set_fact:
      master_ip: "{{ lookup('env', 'GI_MASTER_IP').split(',') }}"
      master_mac: "{{ lookup('env', 'GI_MASTER_MAC_ADDRESS').split(',') }}"
      master_name: "{{ lookup('env', 'GI_MASTER_NAME').split(',') }}"

  - name: Check master configuration
    fail: msg="Variable {{ item.name }} is not set"
    when: item.value == ""
    loop:
      - { name: "GI_MASTER_IP", value: "{{ master_ip }}" }
      - { name: "GI_MASTER_MAC_ADDRESS", value: "{{ master_mac }}" }
      - { name: "GI_MASTER_NAME", value: "{{ master_name }}" }

  - name: Set OCS array
    set_fact:
      ocs_ip: "{{ lookup('env', 'GI_OCS_IP').split(',') }}"
      ocs_mac: "{{ lookup('env', 'GI_OCS_MAC_ADDRESS').split(',') }}"
      ocs_name: "{{ lookup('env', 'GI_OCS_NAME').split(',') }}"
    when: is_ocs_tainted == 'Y'

  - name: Set workers arrays
    set_fact:
      worker_ip: "{{ lookup('env', 'GI_WORKER_IP').split(',') }}"
      worker_mac: "{{ lookup('env', 'GI_WORKER_MAC_ADDRESS').split(',') }}"
      worker_name: "{{ lookup('env', 'GI_WORKER_NAME').split(',') }}"
    when: is_master_only == 'N'

  - set_fact:
      rook_registry: "quay.io/ceph/ceph:v16.2.6"
    when: internet_type != 'A' and storage_type == 'R'

  - set_fact:
      rook_registry: "registry.{{ domain }}:5000/rook/ceph:v16.2.6"
    when: internet_type == 'A' and storage_type == 'R'

  - name: Waiting for OCP cluster deployment (it takes 15-40 minutes)
    command: openshift-install --dir=../ocp wait-for bootstrap-complete

  - name: Check bootstrap availability
    command:
      cmd: "ping -c 1 {{ boot_name }}.{{ domain }}"
    register: boot_availability
    ignore_errors: yes

  - name: Stop bootstrap
    shell:
      cmd: "ssh -l core {{ boot_name }}.{{ domain }} -i ~/.ssh/cluster_id_rsa sudo shutdown -h +1"
    remote_user: core
    args:
      warn: false
    when: boot_availability.rc != 2 and boot_availability.rc != 1

  - name: Wait for boostrap shutdown
    pause:
      minutes: 1
    when: boot_availability.rc != 2 and boot_availability.rc != 1

  - name: Remove DNS records
    lineinfile:
      path: /etc/dnsmasq.conf
      regexp: "{{ item.regexp }}"
      state: absent
    with_items:
      - { regexp: "^address=/matchbox." }
      - { regexp: "^address=/boot." }
      - { regexp: "^#TFTP" }
      - { regexp: "^tftp-" }
      - { regexp: "^enable-tftp" }
      - { regexp: "^dhcp-match" }
      - { regexp: "^dhcp-boot" }
      - { regexp: "^dhcp-userclass" }

  - name: Restart dnsmasq
    service:
      name: dnsmasq
      state: restarted
      enabled: yes

  - name: Stop unused services
    service:
      name: "{{ item.name }}"
      state: stopped
      enabled: no
    with_items:
      - { name: "matchbox" }

  - name: Reconfigure HA Proxy
    lineinfile:
      path: /etc/haproxy/haproxy.cfg
      regexp: "{{ item.regexp }}"
      state: absent
    with_items:
      - { regexp: '^ server m0' }

  - name: Restart HA Proxy
    service:
      name: haproxy
      state: restarted
      enabled: yes

  - name: Check cluster nodes health and approve CSR's if needed
    vars:
      node_number: "{{ master_ip|length+worker_ip|default([])|length+ocs_ip|default([])|length }}"
    shell: ../scripts/check_cluster_health.sh
    register: cluster_health
    until: node_number == cluster_health.stdout
    retries: 30
    delay: 60

  - name: Wait for cluster operators
    shell:
      cmd: "oc get co --kubeconfig=../ocp/auth/kubeconfig --no-headers|awk '{ print $3$4$5 }'|grep -v TrueFalseFalse|wc -l"
    register: co_status
    until: "co_status.stdout == \"0\""
    retries: 150 
    delay: 10

  - name: Create htpasswd file
    htpasswd:
      path: ../gi-temp/ocadmin.htpasswd
      name: "{{ ocadmin }}"
      password: "{{ ocadmin_password }}"

  - name: Register htpasswd file in OCP
    shell:
      cmd: "{{ item.cmd }}"
    with_items:
      - { cmd: "oc create secret generic htpass-secret --from-file=htpasswd=../gi-temp/ocadmin.htpasswd -n openshift-config --kubeconfig ../ocp/auth/kubeconfig" }
      - { cmd: "oc apply -f ../scripts/oauth_provider.yaml --kubeconfig ../ocp/auth/kubeconfig" }
      - { cmd: "oc adm policy add-cluster-role-to-user cluster-admin {{ ocadmin }} --kubeconfig ../ocp/auth/kubeconfig" }
    ignore_errors: yes #if htpasswd has been imported before

  - name: Disable default image sources
    shell:
      cmd: "oc patch OperatorHub cluster --type json -p '[{\"op\": \"add\", \"path\": \"/spec/disableAllDefaultSources\", \"value\": true}]'"
    when: internet_type == 'A'

  - name: Unpack OLM manifests
    shell:
      cmd: tar xf ../gi-temp/manifests.tar -C ../gi-temp
      warn: false
    when: internet_type == 'A'

  - name: Identify image registry name in the import
    shell:
      cmd: "cd  ../gi-temp/manifests-redhat-operator-index;cat catalogSource.yaml | grep image | awk '{print $2}'| awk -F':' '{print $1}'"
    register: old_registry_name
    when: internet_type == 'A'

  - name: Set correct image registry mirror name in catalogSources
    shell:
      cmd: "sed -i 's/{{ old_registry_name.stdout }}/registry.{{ domain }}/g' catalogSource.yaml"
      chdir: "../gi-temp/{{ item }}"
      warn: false
    with_items:
      - manifests-redhat-operator-index
      - manifests-certified-operator-index
      - manifests-redhat-marketplace-index
      - manifests-community-operator-index
    when: internet_type == 'A'

  - name: Set correct image registry mirror name in imageContentSourcePolicy
    shell:
      cmd: "sed -i 's/{{ old_registry_name.stdout }}/registry.{{ domain }}/g' imageContentSourcePolicy.yaml"
      chdir: "../gi-temp/{{ item }}"
      warn: false
    with_items:
      - manifests-redhat-operator-index
      - manifests-certified-operator-index
      - manifests-redhat-marketplace-index
      - manifests-community-operator-index
    when: internet_type == 'A'

  - name: Configure mirrored catalogSources
    shell:
      cmd: "oc apply -f catalogSource.yaml"
      chdir: "../gi-temp/{{ item }}"
      warn: false
    with_items:
      - manifests-redhat-operator-index
      - manifests-certified-operator-index
      - manifests-redhat-marketplace-index
      - manifests-community-operator-index
    when: internet_type == 'A'

  - name: Configure mirrored imageContentSourcePolicy.yaml
    shell:
      cmd: "oc apply -f imageContentSourcePolicy.yaml"
      chdir: "../gi-temp/{{ item }}"
      warn: false
    with_items:
      - manifests-redhat-operator-index
      - manifests-certified-operator-index
      - manifests-redhat-marketplace-index
      - manifests-community-operator-index
    when: internet_type == 'A'

  - name: Wait - cluster stabilization
    pause:
      minutes: 8
    when: internet_type == 'A'

  - name: Check cluster nodes health after Content Source Policy change
    shell: ../scripts/check_cluster_health_operators.sh
    register: cluster_health_operators
    until: cluster_health_operators.stdout == "0"
    retries: 100
    delay: 30
    when: internet_type == 'A'

  - name: Wait for cluster operators after mirrored operator images setup (can take 20-40 minutes)
    shell:
      cmd: "oc get co --kubeconfig=../ocp/auth/kubeconfig --no-headers|awk '{ print $3$4$5 }'|grep -v TrueFalseFalse|wc -l"
    register: co_status
    until: "co_status.stdout == \"0\""
    retries: 150
    delay: 30
    when: false and internet_type == 'A'

  - name: Configure OCS nodes on workers
    shell:
      cmd: "oc label nodes {{ item }}.{{ domain }} cluster.ocs.openshift.io/openshift-storage='' --kubeconfig ../ocp/auth/kubeconfig --overwrite=true"
    with_items: "{{ worker_name|list if worker_name|length == 2 else worker_name[:3]|list }}"
    when: storage_type == "O" and is_master_only == 'N' and is_ocs_tainted == 'N'

  - name: Configure OCS nodes for taint
    shell: |
      oc label nodes {{ item }}.{{ domain }} cluster.ocs.openshift.io/openshift-storage='' --kubeconfig ../ocp/auth/kubeconfig --overwrite=true
      oc label nodes {{ item }}.{{ domain }} node-role.kubernetes.io/infra='' --kubeconfig ../ocp/auth/kubeconfig --overwrite=true
    with_items: "{{ ocs_name|list }}"
    when: storage_type == "O" and is_master_only == 'N' and is_ocs_tainted == 'Y'

  - name: Configure OCS nodes on masters
    shell:
      cmd: "oc label nodes {{ item }}.{{ domain }} cluster.ocs.openshift.io/openshift-storage='' --kubeconfig ../ocp/auth/kubeconfig --overwrite=true"
    with_items: "{{ master_name|list }}"
    when: storage_type == "O" and is_master_only == 'Y'

  - name: Create OCS namespaces
    shell:
      cmd: "oc create namespace {{ item }}"
    with_items:
      - openshift-local-storage
      - openshift-storage
    ignore_errors: yes
    when: storage_type == "O"

  - name: Configure local storage operator file
    vars:
      operator_source: "{{ 'redhat-operators' if internet_type != 'A' else 'redhat-operator-index' }}"
    template:
      src: "local-storage-op.j2"
      dest: "../scripts/local-storage-op.yaml"
    when: storage_type == "O"

  - name: Configure local storage operator
    shell:
      cmd: "{{ item }}"
    loop:
      - "oc apply -f ../scripts/local-storage-op.yaml --kubeconfig ../ocp/auth/kubeconfig"
    when: storage_type == "O"

  - name: Wait for local storage operator
    shell:
      cmd: "oc get csv -n openshift-local-storage --kubeconfig=../ocp/auth/kubeconfig --no-headers -o custom-columns=STATUS:.status.phase"
    register: ls_operator_status
    until: "ls_operator_status.stdout == \"Succeeded\""
    retries: 30
    delay: 10
    when: storage_type == "O"

  - name: Configure local storage deployment file with workers
    vars:
      nodes: "{{ worker_name|list if worker_name|length == 2 else worker_name[:3]|list }}"
    template:
      src: "local-storage-vol.j2"
      dest: "../scripts/local-storage-vol.yaml"
    when: storage_type == "O" and is_master_only == 'N' and is_ocs_tainted == 'N'

  - name: Configure local storage deployment file in taint
    vars:
      nodes: "{{ ocs_name|list }}"
    template:
      src: "local-storage-vol-tainted.j2"
      dest: "../scripts/local-storage-vol.yaml"
    when: storage_type == "O" and is_master_only == 'N' and is_ocs_tainted == 'Y'

  - name: Configure local storage deployment file with masters only
    vars:
      nodes: "{{ master_name|list }}"
    template:
      src: "local-storage-vol.j2"
      dest: "../scripts/local-storage-vol.yaml"
    when: storage_type == "O" and is_master_only == 'Y'

  - name: Deploy local storage
    shell:
      cmd: "{{ item }}"
    loop:
      - "oc apply -f ../scripts/local-storage-vol.yaml --kubeconfig ../ocp/auth/kubeconfig"
    when: storage_type == "O"

  - name: Wait for local storage deployment
    shell:
      cmd: "oc get pv | grep localblock-sc | wc -l"
    register: ls_status
    until: "ls_status.stdout|int >= 3"
    retries: 30
    delay: 10
    when: storage_type == "O"

  - name: Taint OCS nodes
    shell:
      cmd: "oc adm taint node {{ item }}.{{ domain }} node.ocs.openshift.io/storage=\"true\":NoSchedule"
    with_items: "{{ ocs_name|list }}"
    when: storage_type == "O" and is_master_only == 'N' and is_ocs_tainted == 'Y'
    ignore_errors: yes

  - name: Configure OCS operator file
    vars:
      operator_source: "{{ 'redhat-operators' if internet_type != 'A' else 'redhat-operator-index' }}"
    template:
      src: "ocs-op.j2"
      dest: "../scripts/ocs-op.yaml"
    when: storage_type == "O"

  - name: Configure OCS operator
    shell:
      cmd: "{{ item }}"
    loop:
      - "oc apply -f ../scripts/ocs-op.yaml --kubeconfig ../ocp/auth/kubeconfig"
    when: storage_type == "O"

  - name: Wait for OCS operator
    shell:
      cmd: "oc get csv -n openshift-storage --kubeconfig=../ocp/auth/kubeconfig --no-headers -o custom-columns=STATUS:.status.phase"
    register: ocs_operator_status
    until: "ocs_operator_status.stdout == \"Succeeded\""
    retries: 30
    delay: 10
    when: storage_type == "O"

  - name: Configure OCS cluster deployment file
    template:
      src: "ocs-cluster.j2"
      dest: "../scripts/ocs-cluster.yaml"
    when: storage_type == "O"

  - name: Deploy OCS cluster
    shell:
      cmd: "{{ item }}"
    loop:
      - "oc apply -f ../scripts/ocs-cluster.yaml --kubeconfig ../ocp/auth/kubeconfig"
    when: storage_type == "O"

  - name: Wait for OCS cluster deployment
    shell:
      cmd: "oc get pvc -n openshift-storage --no-headers | grep localblock-sc | grep Bound | wc -l"
    register: ocs_status
    until: "ocs_status.stdout|int >= 3"
    retries: 100
    delay: 15
    when: storage_type == "O"

  - name: Wait - OCS installation finalization
    pause:
      minutes: 5
    when: storage_type == "O"

  - name: Configure OCS default storage class
    shell:
      cmd: "{{ item.cmd }}"
    with_items:
      - { cmd: "oc patch storageclass ocs-storagecluster-cephfs --kubeconfig ../ocp/auth/kubeconfig -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'" }
    when: storage_type == "O"

  - name: Configure rook-ceph CRD's
    shell:
      cmd: "oc apply -f ../scripts/rook-latest-crds.yaml --kubeconfig ../ocp/auth/kubeconfig"
    when: storage_type == "R"

  - name: Configure common rook settings
    shell:
      cmd: "oc apply -f ../scripts/rook-latest-common.yaml --kubeconfig ../ocp/auth/kubeconfig"
    when: storage_type == "R"

  - name: Configure rook-ceph cluster file
    vars:
      multiple_per_node: "true"
    template:
      src: "rook-latest-cluster.j2"
      dest: "../scripts/rook-cluster.yaml"
    when: storage_type == "R"

  - name: Configure rook-ceph-rbd-sc file
    vars:
      replica_size: "2"
      requires_replica: "true"
    template:
      src: "rook-storage_class_rbd.j2"
      dest: "../scripts/rook-storage_class_rbd.yaml"
    when: storage_type == "R"

  - name: Configure rook operator file offline
    template:
      src: "rook-latest-operator-offline.j2"
      dest: "../scripts/rook-latest-operator.yaml"
    when: internet_type == 'A' and storage_type == "R"

  - name: Configure rook operator file online
    template:
      src: "rook-latest-operator.j2"
      dest: "../scripts/rook-latest-operator.yaml"
    when: internet_type != 'A' and storage_type == "R"

  - name: Configure rook operator
    shell:
      cmd: "{{ item }}"
    loop:
      - "oc apply -f ../scripts/rook-latest-operator.yaml --kubeconfig ../ocp/auth/kubeconfig"
      - "oc apply -f ../scripts/rook-latest-filesystem.yaml --kubeconfig ../ocp/auth/kubeconfig"
    when: storage_type == "R"

  - name: Wait for Rook operator
    shell:
      cmd: "oc get pods -n rook-ceph --kubeconfig=../ocp/auth/kubeconfig --selector app=rook-ceph-operator --no-headers -o custom-columns=STATUS:.status.phase|grep -v Running|wc -l"
    register: rook_operator_status
    until: "rook_operator_status.stdout == \"0\""
    retries: 30
    delay: 10
    when: storage_type == "R"

  - name: Deploy rook-ceph cluster
    shell:
      cmd: "{{ item.cmd }}"
    with_items:
      - { cmd: "oc apply -f ../scripts/'rook-cluster.yaml' --kubeconfig ../ocp/auth/kubeconfig" }
    when: storage_type == "R"

  - name: Wait for correct Rook Ceph cluster deployment
    shell:
      cmd: "oc get cephcluster -n rook-ceph --kubeconfig ../ocp/auth/kubeconfig --no-headers -o custom-columns=HEALTH:.status.ceph.health"
    register: ceph_installation_status
    until: "ceph_installation_status.stdout == \"HEALTH_OK\" or ceph_installation_status.stdout == \"HEALTH_WARN\""
    retries: 60
    delay: 15
    when: storage_type == "R"

  - name: Configure storage classes
    shell:
      cmd: "{{ item.cmd }}"
    with_items:
      - { cmd: "oc apply -f ../scripts/rook-storage_class_rbd.yaml --kubeconfig ../ocp/auth/kubeconfig" }
      - { cmd: "oc apply -f ../scripts/rook-storage_class_cephfs.yaml --kubeconfig ../ocp/auth/kubeconfig" }
      - { cmd: "oc patch storageclass rook-ceph-block --kubeconfig ../ocp/auth/kubeconfig -p '{\"metadata\": {\"annotations\":{\"storageclass.kubernetes.io/is-default-class\":\"true\"}}}'" }
    when: storage_type == "R"

  - name: Configure registry PVC file
    vars:
      storage_class_rw_many: "{{ 'rook-cephfs' if storage_type == 'R' else 'ocs-storagecluster-cephfs' }}"
    template:
      src: "ocp_registry_pvc.j2"
      dest: "../scripts/ocp_registry_pvc.yaml"

  - name: Create PVC for registry storage
    shell:
      cmd: oc apply -f ../scripts/ocp_registry_pvc.yaml --kubeconfig ../ocp/auth/kubeconfig

  - name: Wait for PVC
    shell:
      cmd: "oc get pvc -n openshift-image-registry --kubeconfig=../ocp/auth/kubeconfig registry --no-headers -o custom-columns=STATUS:.status.phase"
    register: image_pvc_status
    until: "image_pvc_status.stdout == \"Bound\""
    retries: 30
    delay: 10

  - name: Configure OCP registry with PVC
    shell:
      cmd: "{{ item.cmd }}"
    with_items:
      - { cmd: "oc patch configs.imageregistry.operator.openshift.io/cluster --kubeconfig ../ocp/auth/kubeconfig --type=merge --patch '{\"spec\":{\"storage\":{\"pvc\":{\"claim\": \"registry\"}}}}'" }
      - { cmd: "oc patch configs.imageregistry.operator.openshift.io/cluster --kubeconfig ../ocp/auth/kubeconfig --type=merge --patch '{\"spec\": {\"managementState\": \"Managed\"}}'" }
    when: true

  - pause:
      seconds: 30

  - name: Wait for Image registry successful reconfiguration
    shell:
      cmd: "oc get clusteroperators image-registry --kubeconfig ../ocp/auth/kubeconfig --no-headers | awk '{ print $3\":\"$4\":\"$5 }'"
    register: image_registry_status
    until: "image_registry_status.stdout.split(\":\")[0] == \"True\" and image_registry_status.stdout.split(\":\")[1] == \"False\" and image_registry_status.stdout.split(\":\")[2] == \"False\""
    retries: 20
    delay: 10
    when: true

  - name: Set public route for image registry
    shell:
      cmd: oc patch configs.imageregistry.operator.openshift.io/cluster --patch '{"spec":{"defaultRoute":true}}' --type=merge --kubeconfig ../ocp/auth/kubeconfig

  - pause:
      seconds: 30

  - name: Wait for API server successful reconfiguration
    shell:
      cmd: "oc get clusteroperators kube-apiserver --kubeconfig ../ocp/auth/kubeconfig --no-headers | awk '{ print $3\":\"$4\":\"$5 }'"
    register: image_registry_status
    until: "image_registry_status.stdout.split(\":\")[0] == \"True\" and image_registry_status.stdout.split(\":\")[1] == \"False\" and image_registry_status.stdout.split(\":\")[2] == \"False\""
    retries: 60
    delay: 30
    when: true

  - debug:
        msg:
          - "OpenShift {{ ocp_release }} cluster installation finished"
          - Add to hosts on your web browser workstation this line
          - "{{ bas_ip }} console-openshift-console.apps.{{ domain }} oauth-openshift.apps.{{ domain }}"
          - "Login to OCP console as {{ ocadmin }} user - https://console-openshift-console.apps.{{ domain }}"  

  - debug:
        msg:
          - To install ICS execute playbook 'ansible-playbook playbooks/04-install-ics.yaml'
    when: is_ics == 'Y'
